# $Id$
CC		= @CC@
CFLAGS		= -Wall @CFLAGS@ @DEFS@
CPPFLAGS	= @CPPFLAGS@
LDFLAGS		= @LDFLAGS@ @LIBS@
DESTDIR		=
prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@
mandir		= @mandir@
INSTALL		= @INSTALL@
LANGDIR		= @datadir@/locale
DEFS		= -I. -I./libidn -DLANGDIR=\"$(LANGDIR)\"
OBJ		= whois.o i18n.o

VERSION		= @PACKAGE_VERSION@
NAME		= @PACKAGE_NAME@

RM		= @RM@ -f
MKDIR		= @MKDIR@ -p
LN		= @LN_S@ -f

all: punyconv raceconv whois
	make -C po
	-strip whois libidn/punyconv libracode/raceconv

whois: $(OBJ)
	$(CC) -Wall $(CFLAGS) $(DEFS) $(OBJ) -o whois $(LDFLAGS)

punyconv:
	make -C libidn CFLAGS="$(CFLAGS)" LANGDIR=$(LANGDIR)

raceconv:
	make -C libracode CFLAGS="$(CFLAGS)" LANGDIR=$(LANGDIR)

whois.o: whois.c i18n.h config.h
	$(CC)  -Wall $(CFLAGS) $(DEFS) $(CPPFLAGS) \
		-DNAME=\"$(NAME)\" -DPVERSION=\"$(VERSION)\" -c whois.c

i18n.o: i18n.c i18n.h config.h
	$(CC) $(CFLAGS) $(DEFS) $(CPPFLAGS) -c i18n.c

po-install:
	make -C po DESTDIR=$(DESTDIR) langdir=$(LANGDIR) install

clean:
	-$(RM) whois *.o *~
	make -C po clean
	make -C libidn clean
	make -C libracode clean

distclean: clean
	-$(RM) Makefile libidn/Makefile libracode/Makefile config.h \
	       po/Makefile config.cache config.log config.status

install: po-install
	$(MKDIR) -p $(DESTDIR)$(bindir) $(DESTDIR)$(mandir)/{man1,ko/man1}

	$(INSTALL) -m 755 whois $(DESTDIR)$(bindir)
	$(INSTALL) -m 644 docs/kwhois.1 $(DESTDIR)$(mandir)/man1/kwhois.1
	$(INSTALL) -m 644 docs/whois.1 $(DESTDIR)$(mandir)/man1/whois.1
	$(INSTALL) -m 644 docs/kwhois.1.kr $(DESTDIR)$(mandir)/ko/man1/kwhois.1
	$(INSTALL) -m 644 docs/whois.1.kr $(DESTDIR)$(mandir)/ko/man1/whois.1
	$(LN) whois $(DESTDIR)$(bindir)/kwhois
	$(INSTALL) -m 755 libidn/punyconv $(DESTDIR)$(bindir)
	$(INSTALL) -m 755 libracode/raceconv $(DESTDIR)$(bindir)
